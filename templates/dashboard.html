{% extends 'base.html' %}
{% block title %}Dashboard â€” PhishShield AI{% endblock %}

{% block content %}
<!-- Header -->
<div class="flex-between animate-in" style="margin-bottom:2rem; flex-wrap:wrap; gap:1rem;">
  <div>
    <h1 class="page-title" style="margin-bottom:0.25rem;">
      Welcome back, <span>{{ current_user.username }}</span> ğŸ‘‹
    </h1>
    <p class="text-muted" style="font-size:0.9rem;">Here's your phishing detection overview</p>
  </div>
  <a href="{{ url_for('analysis') }}" class="btn btn-primary">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
    Analyze Message
  </a>
</div>

<!-- Stats Cards -->
<div class="grid-4 animate-in-delay-1" style="margin-bottom:2rem;">
  <div class="card" style="border-color:rgba(0,217,255,0.2); text-align:center;">
    <div style="font-size:2.5rem; font-weight:800; color:var(--neon-blue); line-height:1; text-shadow:0 0 20px rgba(0,217,255,0.5);">{{ total }}</div>
    <div class="text-muted" style="font-size:0.8rem; margin-top:0.4rem; text-transform:uppercase; letter-spacing:0.06em;">Total Analyses</div>
    <div style="margin-top:0.75rem;">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#00D9FF" stroke-width="2" opacity="0.6"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
    </div>
  </div>
  <div class="card" style="border-color:rgba(57,255,20,0.2); text-align:center;">
    <div style="font-size:2.5rem; font-weight:800; color:var(--neon-green); line-height:1; text-shadow:0 0 20px rgba(57,255,20,0.5);">{{ safe_count }}</div>
    <div class="text-muted" style="font-size:0.8rem; margin-top:0.4rem; text-transform:uppercase; letter-spacing:0.06em;">Safe Messages</div>
    <div style="margin-top:0.75rem;">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#39FF14" stroke-width="2" opacity="0.6"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><polyline points="9 12 11 14 15 10"/></svg>
    </div>
  </div>
  <div class="card" style="border-color:rgba(255,215,0,0.2); text-align:center;">
    <div style="font-size:2.5rem; font-weight:800; color:var(--neon-yellow); line-height:1; text-shadow:0 0 20px rgba(255,215,0,0.5);">{{ suspicious_count }}</div>
    <div class="text-muted" style="font-size:0.8rem; margin-top:0.4rem; text-transform:uppercase; letter-spacing:0.06em;">Suspicious</div>
    <div style="margin-top:0.75rem;">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#FFD700" stroke-width="2" opacity="0.6"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
    </div>
  </div>
  <div class="card" style="border-color:rgba(255,68,68,0.2); text-align:center;">
    <div style="font-size:2.5rem; font-weight:800; color:var(--neon-red); line-height:1; text-shadow:0 0 20px rgba(255,68,68,0.5);">{{ high_risk_count }}</div>
    <div class="text-muted" style="font-size:0.8rem; margin-top:0.4rem; text-transform:uppercase; letter-spacing:0.06em;">High Risk</div>
    <div style="margin-top:0.75rem;">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#FF4444" stroke-width="2" opacity="0.6"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
    </div>
  </div>
</div>

<!-- Chart + Tips Row -->
<div style="display:grid; grid-template-columns:1fr 1.6fr; gap:1.5rem; margin-bottom:2rem;" class="animate-in-delay-2">
  <!-- Doughnut Chart -->
  <div class="card" style="display:flex; flex-direction:column; align-items:center;">
    <h3 style="font-size:1rem; font-weight:700; margin-bottom:1rem; color:var(--text-primary); align-self:flex-start;">Risk Distribution</h3>
    {% if total > 0 %}
    <div style="position:relative; width:180px; height:180px;">
      <canvas id="riskChart" width="180" height="180"></canvas>
      <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center;">
        <div style="font-size:1.5rem; font-weight:800; color:var(--text-primary);">{{ total }}</div>
        <div style="font-size:0.7rem; color:var(--text-muted);">SCANS</div>
      </div>
    </div>
    <div style="display:flex; gap:1rem; margin-top:1rem; flex-wrap:wrap; justify-content:center;">
      <div style="display:flex; align-items:center; gap:0.35rem; font-size:0.78rem; color:var(--text-muted);">
        <div style="width:10px; height:10px; border-radius:50%; background:#39FF14;"></div> Safe
      </div>
      <div style="display:flex; align-items:center; gap:0.35rem; font-size:0.78rem; color:var(--text-muted);">
        <div style="width:10px; height:10px; border-radius:50%; background:#FFD700;"></div> Suspicious
      </div>
      <div style="display:flex; align-items:center; gap:0.35rem; font-size:0.78rem; color:var(--text-muted);">
        <div style="width:10px; height:10px; border-radius:50%; background:#FF4444;"></div> High Risk
      </div>
    </div>
    {% else %}
    <div style="text-align:center; padding:2rem 0;">
      <div style="font-size:3rem; opacity:0.3;">ğŸ“Š</div>
      <p class="text-muted" style="margin-top:0.5rem; font-size:0.875rem;">No analyses yet</p>
      <a href="{{ url_for('analysis') }}" class="btn btn-primary" style="margin-top:1rem; font-size:0.8rem; padding:0.5rem 1rem;">Start Analyzing</a>
    </div>
    {% endif %}
  </div>

  <!-- Phishing Tips -->
  <div class="card">
    <h3 style="font-size:1rem; font-weight:700; margin-bottom:1rem;">ğŸ›¡ï¸ Phishing Awareness Tips</h3>
    <div id="tips-carousel">
      {% set tips = [
        ("ğŸ£ Check the Sender", "Always verify the sender's email address â€” phishers often use look-alike domains like 'paypa1.com' instead of 'paypal.com'."),
        ("ğŸ”— Hover Before You Click", "Hover over any link to see the real URL before clicking. If the URL looks strange or doesn't match the brand, don't click."),
        ("ğŸ” Never Share OTPs", "No legitimate bank, government agency, or company will ever ask for your OTP or password via email or SMS."),
        ("â° Urgency = Red Flag", "Phishers use urgency tactics like 'Your account will be closed in 24 hours!' to make you act without thinking."),
        ("ğŸ“ Beware Attachments", "Unexpected email attachments can contain malware. Even if it looks like a PDF, verify the sender first."),
        ("ğŸŒ HTTPS â‰  Safe", "A site having HTTPS doesn't mean it's legitimate â€” phishing sites can have SSL certificates too. Check the full domain."),
      ] %}
      {% for title, tip in tips %}
      <div class="tip-item {% if not loop.first %}tip-hidden{% endif %}"
           style="{% if not loop.first %}display:none;{% endif %} animation: fadeIn 0.4s ease;">
        <div style="display:flex; align-items:flex-start; gap:0.75rem; padding:0.85rem; background:rgba(0,217,255,0.04); border:1px solid rgba(0,217,255,0.1); border-radius:10px;">
          <div style="font-size:1.5rem; line-height:1; flex-shrink:0;">{{ title.split(' ')[0] }}</div>
          <div>
            <div style="font-weight:700; font-size:0.9rem; color:var(--text-primary); margin-bottom:0.25rem;">{{ title.split(' ', 1)[1] }}</div>
            <div style="font-size:0.85rem; color:var(--text-muted); line-height:1.5;">{{ tip }}</div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    <div style="display:flex; gap:0.5rem; justify-content:flex-end; margin-top:1rem;">
      <button onclick="prevTip()" class="btn btn-outline" style="padding:0.4rem 0.8rem; font-size:0.8rem;">â† Prev</button>
      <button onclick="nextTip()" class="btn btn-primary" style="padding:0.4rem 0.8rem; font-size:0.8rem;">Next â†’</button>
    </div>
  </div>
</div>

<!-- Recent Analyses -->
<div class="card animate-in-delay-3">
  <div class="flex-between" style="margin-bottom:1.25rem;">
    <h3 style="font-size:1rem; font-weight:700;">Recent Analyses</h3>
    <a href="{{ url_for('analysis') }}" class="btn btn-outline" style="padding:0.4rem 0.9rem; font-size:0.8rem;">New Analysis</a>
  </div>
  {% if analyses %}
  <div style="overflow-x:auto;">
    <table class="table">
      <thead>
        <tr>
          <th>#</th>
          <th>Timestamp</th>
          <th>Risk Level</th>
          <th>Score</th>
          <th>Rule-Based</th>
          <th>NLP</th>
          <th>Regex</th>
        </tr>
      </thead>
      <tbody>
        {% for a in analyses %}
        <tr>
          <td style="color:var(--text-muted); font-size:0.8rem;">{{ loop.index }}</td>
          <td style="font-size:0.85rem; color:var(--text-muted);">
            {{ a.timestamp.strftime('%b %d, %Y %H:%M') }}
          </td>
          <td>
            <span class="badge badge-{{ a.risk_level }}">
              {% if a.risk_level == 'safe' %}ğŸŸ¢ Safe
              {% elif a.risk_level == 'suspicious' %}ğŸŸ¡ Suspicious
              {% else %}ğŸ”´ High Risk{% endif %}
            </span>
          </td>
          <td>
            <div style="display:flex; align-items:center; gap:0.5rem;">
              <div class="score-bar" style="width:60px;">
                <div class="score-fill" style="width:{{ a.risk_score }}%;
                  background:{% if a.risk_level=='safe' %}var(--neon-green){% elif a.risk_level=='suspicious' %}var(--neon-yellow){% else %}var(--neon-red){% endif %};"></div>
              </div>
              <span style="font-size:0.85rem; font-weight:600;">{{ a.risk_score }}</span>
            </div>
          </td>
          <td style="font-size:0.85rem;">{{ "%.0f"|format(a.rule_score or 0) }}</td>
          <td style="font-size:0.85rem;">{{ "%.0f"|format(a.nlp_score or 0) }}</td>
          <td style="font-size:0.85rem;">{{ "%.0f"|format(a.regex_score or 0) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div style="text-align:center; padding:3rem 0;">
    <div style="font-size:3.5rem; opacity:0.25; margin-bottom:0.75rem;">ğŸ”</div>
    <p class="text-muted">No analyses yet. Start by analyzing a suspicious message!</p>
    <a href="{{ url_for('analysis') }}" class="btn btn-primary" style="margin-top:1rem;">Analyze Your First Message</a>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
{% if total > 0 %}
// Doughnut chart
const ctx = document.getElementById('riskChart').getContext('2d');
new Chart(ctx, {
  type: 'doughnut',
  data: {
    labels: ['Safe', 'Suspicious', 'High Risk'],
    datasets: [{
      data: [{{ safe_count }}, {{ suspicious_count }}, {{ high_risk_count }}],
      backgroundColor: ['rgba(57,255,20,0.8)', 'rgba(255,215,0,0.8)', 'rgba(255,68,68,0.8)'],
      borderColor: ['#39FF14', '#FFD700', '#FF4444'],
      borderWidth: 2,
      hoverOffset: 8,
    }]
  },
  options: {
    cutout: '72%',
    plugins: { legend: { display: false } },
    animation: { animateRotate: true, duration: 1200 },
  }
});
{% endif %}

// Tips carousel
const tipItems = document.querySelectorAll('.tip-item');
let currentTip = 0;
function showTip(n) {
  tipItems[currentTip].style.display = 'none';
  currentTip = (n + tipItems.length) % tipItems.length;
  tipItems[currentTip].style.display = 'block';
}
function nextTip() { showTip(currentTip + 1); }
function prevTip() { showTip(currentTip - 1); }

// Auto-rotate tips every 6s
setInterval(nextTip, 6000);
</script>
{% endblock %}
